<div class="room-management-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="container-fluid">
      <h1><i class="bi bi-gear-fill"></i> Room Management System</h1>
      <p class="text-muted">Admin Dashboard - Manage rooms, buildings, bookings and users</p>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="container-fluid mt-3">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <button class="nav-link" [class.active]="activeTab === 'overview'" 
                (click)="activeTab = 'overview'">
          <i class="bi bi-speedometer2"></i> Overview
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="activeTab === 'rooms'" 
                (click)="activeTab = 'rooms'">
          <i class="bi bi-door-open"></i> Rooms
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="activeTab === 'buildings'" 
                (click)="activeTab = 'buildings'">
          <i class="bi bi-building"></i> Buildings
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="activeTab === 'bookings'" 
                (click)="activeTab = 'bookings'">
          <i class="bi bi-calendar-check"></i> Bookings
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" [class.active]="activeTab === 'users'" 
                (click)="activeTab = 'users'">
          <i class="bi bi-people"></i> Users
        </button>
      </li>
    </ul>
  </div>

  <!-- Tab Content -->
  <div class="container-fluid mt-4">
    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'" class="tab-content">
      <!-- Statistics Cards Row 1 -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stat-card card text-white bg-primary">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-door-open"></i></div>
              <h3>{{ statistics.totalRooms }}</h3>
              <p>Total Rooms</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card card text-white bg-success">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
              <h3>{{ statistics.availableRooms }}</h3>
              <p>Available Rooms</p>
            </div>
          </div>
        </div>
        <!-- hidden until buildings issue is fixed -->
        <div class="col-md-3">
          <div class="stat-card card text-white bg-info">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-building"></i></div>
              <h3>{{ statistics.totalBuildings }}</h3>
              <p>Buildings</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card card text-white bg-warning">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
              <h3>{{ statistics.totalBookings }}</h3>
              <p>Active Bookings</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Cards Row 2 -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stat-card card text-white bg-secondary">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-people"></i></div>
              <h3>{{ statistics.totalUsers }}</h3>
              <p>Registered Users</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card card text-white bg-danger">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-percent"></i></div>
              <h3>{{ statistics.roomUtilization }}%</h3>
              <p>Room Utilization</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card card text-white bg-dark">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-calendar-day"></i></div>
              <h3>{{ statistics.todayBookings }}</h3>
              <p>Today's Bookings</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-card card text-white bg-purple">
            <div class="card-body">
              <div class="stat-icon"><i class="bi bi-calendar-week"></i></div>
              <h3>{{ statistics.weekBookings }}</h3>
              <p>This Week</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Stats and Recent Activity -->
      <div class="row g-3">
        <div class="col-md-6">
  <div class="card">
    <div class="card-header">
      <h5><i class="bi bi-activity"></i> System Overview</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <span>Room Utilization Rate</span>
          <strong>{{ statistics.roomUtilization }}%</strong>
        </div>
        <div class="progress mt-2">
          <div class="progress-bar" [style.width.%]="statistics.roomUtilization"></div>
        </div>
      </div>
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <span>Most Booked Room</span>
          <strong>{{ statistics.mostBookedRoom }}</strong>
        </div>
      </div>
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <span>Least Booked Room</span>
          <strong>{{ statistics.leastBookedRoom }}</strong>
        </div>
      </div>
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <span>Total Users</span>
          <strong>{{ statistics.totalUsers }}</strong>
        </div>
      </div>
      <div>
        <div class="d-flex justify-content-between">
          <span>Active Bookings</span>
          <strong>{{ statistics.totalBookings }}</strong>
        </div>
      </div>
    </div>
  </div>
</div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="bi bi-clock-history"></i> Recent Bookings</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Room</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let booking of bookings.slice(0, 5)">
                      <td>{{ booking.roomName }}</td>
                      <td>{{ booking.bookingDate | slice:0:10 }}</td> 
                      <!-- <td>{{ booking.bookingDate }}</td> old one shows the whole date format -->
                      <td>{{ booking.startTime }} - {{ booking.endTime }}</td>
                      <td>
                        <span class="badge" 
                              [class.bg-success]="booking.status === 'active'"
                              [class.bg-secondary]="booking.status === 'cancelled'"
                              [class.bg-primary]="booking.status === 'completed'">
                          {{ booking.status }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div *ngIf="hasNoBookings()" class="text-center text-muted">
                  No bookings yet
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rooms Tab -->
    <div *ngIf="activeTab === 'rooms'" class="tab-content">
      
      <!-- Debug info (remove this after fixing) -->
      <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
        <strong>Debug Info:</strong>
        Buildings loaded: {{ buildings.length }} | 
        Rooms loaded: {{ rooms.length }} | 
        Show form: {{ showRoomForm }}
        <button class="btn btn-sm btn-warning ms-2" (click)="addSampleBuildings()" *ngIf="buildings.length === 0">
          Add Sample Buildings
        </button>
      </div>

      <!-- Header with Add Button -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Manage Rooms</h3>
        <div>
          <!-- Show loading status -->
          <span class="badge bg-warning me-2" *ngIf="buildings.length === 0">
            Buildings: Loading...
          </span>
          <span class="badge bg-success me-2" *ngIf="buildings.length > 0">
            Buildings: {{ buildings.length }} loaded
          </span>
          
          <!-- Always show button -->
          <button class="btn btn-primary" (click)="showAddRoomForm()">
            <i class="bi bi-plus-circle"></i> 
            Add Room
          </button>
        </div>
      </div>

      <!-- Room Form -->
      <div *ngIf="showRoomForm" class="card mb-4">
        <div class="card-header">
          <h5>{{ editingRoom ? 'Edit Room' : 'Add New Room' }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="roomForm" class="row g-3">
            <div class="col-md-2">
              <label class="form-label">ID</label>
              <input type="number" class="form-control" formControlName="id" [readonly]="editingRoom">
            </div>
            <div class="col-md-4">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" formControlName="name" placeholder="e.g., Room 101">
            </div>
            <div class="col-md-3">
              <label class="form-label">Type</label>
              <select class="form-select" formControlName="type">
                <option *ngFor="let type of roomTypeOptions" [value]="type.value">{{ type.label }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Building</label>
              <div>
                <!-- Show building dropdown with fallback options -->
                <select class="form-select" formControlName="building">
                  <option value="" disabled>Select a building</option>
                  <option *ngFor="let building of buildings" [value]="building.getName()">
                    {{ building.getName() }}
                  </option>
                  <!-- Fallback options -->
                  <option *ngIf="buildings.length === 0 || !hasBuilding('D')" value="D">D</option>
                  <option *ngIf="buildings.length === 0 || !hasBuilding('M')" value="M">M</option>
                </select>
                
                <div class="form-text text-muted" *ngIf="buildings.length === 0">
                  Buildings are loading... Using fallback options D and M.
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Floor</label>
              <input type="number" class="form-control" formControlName="floor" min="0">
            </div>
            <div class="col-md-2">
              <label class="form-label">Capacity</label>
              <input type="number" class="form-control" formControlName="capacity" min="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select class="form-select" formControlName="status">
                <option value="0">Available</option>
                <option value="1">Booked</option>
              </select>
            </div>
            <div class="col-md-3">
              <div class="form-check mt-4">
                <input type="checkbox" class="form-check-input" formControlName="accessible" id="accessible">
                <label class="form-check-label" for="accessible">
                  Wheelchair Accessible
                </label>
              </div>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-success me-2" (click)="saveRoom()">
                <i class="bi bi-check-circle"></i> Save
              </button>
              <button type="button" class="btn btn-secondary" (click)="showRoomForm = false">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Rooms Table -->
      <div class="card">
        <div class="card-body">
          <div *ngIf="rooms.length === 0" class="text-center py-4">
            <i class="bi bi-door-open" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-2">No rooms found. Add your first room!</p>
          </div>
          
          <div class="table-responsive" *ngIf="rooms.length > 0">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Building</th>
                  <th>Floor</th>
                  <th>Capacity</th>
                  <th>Status</th>
                  <th>Accessible</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let room of rooms">
                  <td>{{ room.getId() }}</td>
                  <td>{{ room.getName() }}</td>
                  <td>{{ getRoomTypeDisplay(room) }}</td>
                  <td>{{ room.getBuilding() }}</td>
                  <td>{{ room.getFloor() }}</td>
                  <td>{{ room.getCapacity() }}</td>
                  <td>
                    <span class="badge" [class.bg-success]="room.getStatus() === 0" 
                          [class.bg-danger]="room.getStatus() === 1">
                      {{ room.getStatus() === 0 ? 'Available' : 'Booked' }}
                    </span>
                  </td>
                  <td>
                    <i class="bi bi-check-circle text-success" *ngIf="room.isAccessible()"></i>
                    <i class="bi bi-x-circle text-danger" *ngIf="!room.isAccessible()"></i>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" (click)="editRoom(room)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="deleteRoom(room)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Buildings Tab -->
    <div *ngIf="activeTab === 'buildings'" class="tab-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Manage Buildings</h3>
        <button class="btn btn-primary" (click)="showAddBuildingForm()">
          <i class="bi bi-plus-circle"></i> Add New Building
        </button>
      </div>

      <!-- Building Form -->
      <div *ngIf="showBuildingForm" class="card mb-4">
        <div class="card-header">
          <h5>{{ editingBuilding ? 'Edit Building' : 'Add New Building' }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="buildingForm" class="row g-3">
            <div class="col-md-2">
              <label class="form-label">ID</label>
              <input type="number" class="form-control" formControlName="id" [readonly]="editingBuilding">
            </div>
            <div class="col-md-4">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" formControlName="name" placeholder="e.g., Main Building">
            </div>
            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" formControlName="description" placeholder="Building description">
            </div>
            <div class="col-md-2">
              <label class="form-label">Floors</label>
              <input type="number" class="form-control" formControlName="floors" min="1">
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-success me-2" (click)="saveBuilding()">
                <i class="bi bi-check-circle"></i> Save
              </button>
              <button type="button" class="btn btn-secondary" (click)="showBuildingForm = false">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Buildings Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Floors</th>
                  <th>Total Rooms</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let building of buildings">
                  <td>{{ building.getId() }}</td>
                  <td>{{ building.getName() }}</td>
                  <td>{{ building.getDescription() }}</td>
                  <td>{{ building.getFloors() }}</td>
                  <td>
                    <span class="badge bg-secondary">
                      {{ getRoomCountForBuilding(building.getName()) }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" (click)="editBuilding(building)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="deleteBuilding(building)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Bookings Tab -->
    <div *ngIf="activeTab === 'bookings'" class="tab-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Manage Bookings</h3>
        <span class="badge bg-info">{{ filteredBookings.length }} bookings</span>
      </div>

      <!-- Booking Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <form [formGroup]="bookingFilterForm" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">From Date</label>
              <input type="date" class="form-control" formControlName="dateFrom">
            </div>
            <div class="col-md-3">
              <label class="form-label">To Date</label>
              <input type="date" class="form-control" formControlName="dateTo">
            </div>
            <div class="col-md-3">
              <label class="form-label">Room</label>
              <select class="form-select" formControlName="roomId">
                <option value="">All Rooms</option>
                <option *ngFor="let room of rooms" [value]="room.getId()">
                  {{ room.getName() }}
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select class="form-select" formControlName="status">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </form>
        </div>
      </div>

      <!-- Bookings Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Room</th>
                  <th>Building</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Purpose</th>
                  <th>Attendees</th>
                  <th>Booked By</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let booking of filteredBookings">
                  <td>{{ booking.id }}</td>
                  <td>{{ booking.roomName }}</td>
                  <td>{{ booking.building }}</td>
                  <td>{{ booking.bookingDate | slice:0:10 }}</td>
                  <!-- <td>{{ booking.bookingDate }}</td> old one shows the whole date format -->
                  <td>{{ booking.startTime }} - {{ booking.endTime }}</td>
                  <td>{{ booking.purpose }}</td>
                  <td>{{ booking.attendees }}</td>
                  <td>{{ booking.bookedBy }}</td>
                  <td>
                    <span class="badge" 
                          [class.bg-success]="booking.status === 'active'"
                          [class.bg-secondary]="booking.status === 'cancelled'"
                          [class.bg-primary]="booking.status === 'completed'">
                      {{ booking.status }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-danger" 
                            (click)="cancelBooking(booking)"
                            [disabled]="booking.status !== 'active'">
                      <i class="bi bi-x-circle"></i> Cancel
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div *ngIf="hasNoFilteredBookings()" class="text-center py-3 text-muted">
              No bookings found matching the filters.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div *ngIf="activeTab === 'users'" class="tab-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Manage Users</h3>
        <span class="badge bg-info">{{ filteredUsers.length }} users</span>
      </div>

      <!-- User Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <form [formGroup]="userFilterForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Search</label>
              <input type="text" class="form-control" formControlName="searchTerm" 
                     placeholder="Search by name or email...">
            </div>
            <div class="col-md-6">
              <label class="form-label">Role</label>
              <select class="form-select" formControlName="role">
                <option value="">All Roles</option>
                <option [value]="0">Student</option>
                <option [value]="1">Representative</option>
                <option [value]="2">Maintenance Person</option>
                <option [value]="3">Teacher</option>
                <option [value]="4">Admin</option>
                <option [value]="10">Not Logged In</option>
              </select>
            </div>
          </form>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Full Name</th>
                  <th>Date of Birth</th>
                  <th>Gender</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of filteredUsers">
                  <td>{{ user.getEmail() }}</td>
                  <td>{{ user.getFullName() }}</td>
                  <td>{{ user.getDateOfBirth().toLocaleDateString() }}</td>
                  <td>
                    <span class="badge" [class.bg-primary]="isUserMale(user)" 
                          [class.bg-pink]="isUserFemale(user)">
                      {{ user.getGender() }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" 
                          [class.bg-danger]="isUserAdmin(user)" 
                          [class.bg-warning]="isUserTeacher(user)"
                          [class.bg-info]="isUserRepresentative(user)"
                          [class.bg-success]="isUserStudent(user)"
                          [class.bg-primary]="isUserMaintenance(user)"
                          [class.bg-secondary]="isUserNotLoggedIn(user)">
                      {{ getUserRoleLabel(user.getRole()) }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-success me-1" 
                            (click)="promoteUser(user)"
                            [disabled]="isUserAdmin(user)">
                      <i class="bi bi-arrow-up"></i> Promote
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-1" 
                            (click)="demoteUser(user)"
                            [disabled]="isUserStudent(user)">
                      <i class="bi bi-arrow-down"></i> Demote
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="deleteUser(user)">
                      <i class="bi bi-trash">Delete</i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div *ngIf="hasNoFilteredUsers()" class="text-center py-3 text-muted">
              No users found matching the filters.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>