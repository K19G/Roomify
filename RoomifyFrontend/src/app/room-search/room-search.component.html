<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="section-title">Room Management System</h1>
  </div>

  <!-- Maintenance Warning Alert -->
  <div *ngIf="hasActiveMaintenanceWarning()" class="alert alert-warning mb-4" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>
        <strong>Maintenance Notice:</strong>
        <p class="mb-0">{{ getMaintenanceWarningMessage() }}</p>
      </div>
    </div>
  </div>

  <div class="card filter-card mb-4">
    <div class="card-body">
      <h2 class="card-title mb-3">Find the Perfect Room</h2>

      <form [formGroup]="filterForm" class="row g-3">
        <div class="col-md-3">
          <label for="roomType" class="form-label">Room Type</label>
          <select class="form-select" id="roomType" formControlName="roomType">
            <option value="">Any Type</option>
            <option *ngFor="let type of roomTypeOptions" [value]="type.value">{{ type.label }}</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="minCapacity" class="form-label">Minimum Capacity</label>
          <input type="number" class="form-control" id="minCapacity" formControlName="minCapacity" min="0" placeholder="e.g., 20">
        </div>

        <div class="col-md-3">
          <label for="status" class="form-label">Room Status</label>
          <select class="form-select" id="status" formControlName="status">
            <option value="">Any Status</option>
            <option value="0">Available</option>
            <option value="1">Booked</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="accessible" class="form-label">Accessibility</label>
          <select class="form-select" id="accessible" formControlName="accessible">
            <option value="">Any</option>
            <option value="true">Accessible</option>
            <option value="false">Not Accessible</option>
          </select>
        </div>

        <div class="col-12 mt-4">
          <button type="button" class="btn btn-primary me-2" (click)="applyFilters()">
            <i class="bi bi-search me-2"></i> Search Rooms
          </button>
          <button type="button" class="btn btn-outline-secondary" (click)="resetFilters()">
            <i class="bi bi-arrow-counterclockwise me-2"></i> Reset Filters
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="section-title mb-0">Available Rooms</h2>
    <span class="text-muted">{{ filteredRooms.length }} room(s) found</span>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" *ngIf="filteredRooms.length > 0">
    <div class="col" *ngFor="let room of filteredRooms">
      <div class="card room-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h3 class="card-title mb-0">{{ room.getName() }}</h3>
            <span class="badge" [ngClass]="room.getStatus() === 0 ? 'bg-success' : 'bg-danger'">
              {{ room.getStatus() === 0 ? 'Available' : 'Booked' }}
            </span>
          </div>

          <div class="room-detail">
            <i class="bi bi-door-open me-2"></i>
            <span>{{ getRoomType(room) }}</span>
          </div>

          <div class="room-detail">
            <i class="bi bi-building me-2"></i>
            <span>{{ room.getBuilding() }}</span>
          </div>

          <div class="room-detail">
            <i class="bi bi-layers me-2"></i>
            <span>Floor {{ room.getFloor() }}</span>
          </div>

          <div class="room-detail">
            <i class="bi bi-people me-2"></i>
            <span>Capacity: {{ room.getCapacity() }} people</span>
          </div>

          <div class="room-detail" *ngIf="room.isAccessible()">
            <i class="bi bi-universal-access me-2"></i>
            <span>Wheelchair Accessible</span>
          </div>

          <button
            class="btn btn-primary mt-3 w-100"
            [disabled]="room.getStatus() !== 0"
            (click)="selectRoom(room)">
            <i class="bi bi-calendar-plus me-2"></i>
            {{ room.getStatus() === 0 ? 'Book This Room' : 'Not Available' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="filteredRooms.length === 0" class="alert alert-info mt-3">
    <i class="bi bi-info-circle me-2"></i>
    <strong>No rooms found.</strong>
    <span *ngIf="allRooms.length === 0">Loading rooms from database...</span>
    <span *ngIf="allRooms.length > 0">Try adjusting your search filters to find available rooms.</span>
  </div>

  <div *ngIf="selectedRoom" id="bookingForm" class="mt-5">
    <div class="card booking-card">
      <div class="card-header">
        <h2 class="mb-0">Complete Your Booking</h2>
      </div>

      <div class="card-body">
        <!-- Maintenance Warning for Booking Form -->
        <div *ngIf="hasActiveMaintenanceWarning()" class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <small>Please note: Some time slots may be unavailable due to ongoing maintenance.</small>
        </div>

        <div class="selected-room-info mb-4">
          <h4>Selected Room: {{ selectedRoom.getName() }}</h4>
          <div class="row">
            <div class="col-md-6">
              <div class="room-detail">
                <i class="bi bi-door-open me-2"></i>
                <span>{{ getRoomType(selectedRoom) }}</span>
              </div>

              <div class="room-detail">
                <i class="bi bi-building me-2"></i>
                <span>{{ selectedRoom.getBuilding() }}, Floor {{ selectedRoom.getFloor() }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="room-detail">
                <i class="bi bi-people me-2"></i>
                <span>Maximum Capacity: {{ selectedRoom.getCapacity() }} people</span>
              </div>

              <div class="room-detail" *ngIf="selectedRoom.isAccessible()">
                <i class="bi bi-universal-access me-2"></i>
                <span>Wheelchair Accessible</span>
              </div>
            </div>
          </div>
        </div>

        <form [formGroup]="bookingForm" class="row g-3">
          <div class="col-md-4">
            <label for="bookingDate" class="form-label">Date <span class="text-danger">*</span></label>
            <input
              type="date"
              class="form-control"
              [ngClass]="{'is-invalid': bookingForm.get('bookingDate')?.invalid && (bookingForm.get('bookingDate')?.dirty || bookingForm.get('bookingDate')?.touched)}"
              id="bookingDate"
              formControlName="bookingDate"
              [min]="todayDate"
              required>
            <div *ngIf="bookingForm.get('bookingDate')?.invalid && (bookingForm.get('bookingDate')?.dirty || bookingForm.get('bookingDate')?.touched)" class="invalid-feedback">
              <div *ngIf="bookingForm.get('bookingDate')?.errors?.['required']">
                Date is required.
              </div>
              <div *ngIf="bookingForm.get('bookingDate')?.errors?.['pastDate']">
                Booking date cannot be in the past.
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label for="startTime" class="form-label">Start Time <span class="text-danger">*</span></label>
            <input
              type="time"
              class="form-control"
              [ngClass]="{'is-invalid': (bookingForm.get('startTime')?.invalid && (bookingForm.get('startTime')?.dirty || bookingForm.get('startTime')?.touched)) || bookingForm.errors?.['timeInvalid']}"
              id="startTime"
              formControlName="startTime"
              required>
            <div *ngIf="(bookingForm.get('startTime')?.invalid && (bookingForm.get('startTime')?.dirty || bookingForm.get('startTime')?.touched)) || bookingForm.errors?.['timeInvalid']" class="invalid-feedback">
              <div *ngIf="bookingForm.get('startTime')?.errors?.['required']">
                Start time is required.
              </div>
              <div *ngIf="bookingForm.get('startTime')?.errors?.['pastTime']">
                Start time must be in the future.
              </div>
              <div *ngIf="bookingForm.errors?.['timeInvalid']">
                Start time must be before end time.
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label for="endTime" class="form-label">End Time <span class="text-danger">*</span></label>
            <input
              type="time"
              class="form-control"
              [ngClass]="{'is-invalid': (bookingForm.get('endTime')?.invalid && (bookingForm.get('endTime')?.dirty || bookingForm.get('endTime')?.touched)) || bookingForm.errors?.['timeInvalid']}"
              id="endTime"
              formControlName="endTime"
              required>
            <div *ngIf="(bookingForm.get('endTime')?.invalid && (bookingForm.get('endTime')?.dirty || bookingForm.get('endTime')?.touched)) || bookingForm.errors?.['timeInvalid']" class="invalid-feedback">
              <div *ngIf="bookingForm.get('endTime')?.errors?.['required']">
                End time is required.
              </div>
              <div *ngIf="bookingForm.errors?.['timeInvalid']">
                End time must be after start time.
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <label for="bookingPurpose" class="form-label">Purpose <span class="text-danger">*</span></label>
            <input
              type="text"
              class="form-control"
              [ngClass]="{'is-invalid': bookingForm.get('bookingPurpose')?.invalid && (bookingForm.get('bookingPurpose')?.dirty || bookingForm.get('bookingPurpose')?.touched)}"
              id="bookingPurpose"
              formControlName="bookingPurpose"
              placeholder="e.g., Team Meeting, Training Session, Workshop"
              required>
            <div *ngIf="bookingForm.get('bookingPurpose')?.invalid && (bookingForm.get('bookingPurpose')?.dirty || bookingForm.get('bookingPurpose')?.touched)" class="invalid-feedback">
              <div *ngIf="bookingForm.get('bookingPurpose')?.errors?.['required']">
                Purpose is required.
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <label for="attendees" class="form-label">Number of Attendees <span class="text-danger">*</span></label>
            <input
              type="number"
              class="form-control"
              [ngClass]="{'is-invalid': bookingForm.get('attendees')?.invalid && (bookingForm.get('attendees')?.dirty || bookingForm.get('attendees')?.touched)}"
              id="attendees"
              formControlName="attendees"
              min="1"
              [max]="selectedRoom.getCapacity()"
              placeholder="Max: {{ selectedRoom.getCapacity() }}"
              required>
            <small class="text-muted">Maximum: {{ selectedRoom.getCapacity() }} people</small>
            <div *ngIf="bookingForm.get('attendees')?.invalid && (bookingForm.get('attendees')?.dirty || bookingForm.get('attendees')?.touched)" class="invalid-feedback">
              <div *ngIf="bookingForm.get('attendees')?.errors?.['required']">
                Number of attendees is required.
              </div>
              <div *ngIf="bookingForm.get('attendees')?.errors?.['min']">
                Number of attendees must be at least 1.
              </div>
              <div *ngIf="bookingForm.get('attendees')?.errors?.['max']">
                Number of attendees cannot exceed room capacity ({{ selectedRoom.getCapacity() }}).
              </div>
            </div>
          </div>

          <div class="col-12">
            <label for="additionalNotes" class="form-label">Additional Notes (Optional)</label>
            <textarea
              class="form-control"
              id="additionalNotes"
              formControlName="additionalNotes"
              rows="3"
              placeholder="Any special requirements, equipment needs, or other notes..."></textarea>
          </div>

          <div class="col-12 mt-4">
            <button type="button" class="btn btn-primary me-2" (click)="bookRoom()">
              <i class="bi bi-check-circle me-2"></i> Confirm Booking
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="cancelBooking()">
              <i class="bi bi-x-circle me-2"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>